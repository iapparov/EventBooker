
# EventBooker

## Описание

EventBooker это веб-сервис для управления бронированиями на мероприятия (концерты, мастер-классы, курсы, лекции) с автоматическим контролем времени подтверждения брони.

Сервис решает проблему «мертвых броней»: если пользователь не подтвердил или не оплатил бронь в установленный срок, место автоматически освобождается для других участников.

Основные возможности:
- Создание мероприятий: задаются название, дата, количество мест, время жизни брони.
- Бронирование мест: пользователи могут бронировать места на мероприятие.
- Подтверждение брони: бронь необходимо подтвердить в течение указанного времени.
- Автоматическая отмена: фоновый процесс удаляет неоплаченные/неподтвержденные брони.
- Просмотр мероприятий и статусов: отображение свободных мест и текущих бронирований.

Дополнительные функции:
- Уведомления об отмене брони через Email или Telegram.
- Поддержка регистрации и аутентификации пользователей.
- Возможность настраивать индивидуальный срок жизни брони для разных мероприятий.

Цель сервиса — облегчить управление бронированиями, минимизировать «мертвые» места и упростить взаимодействие организаторов с участниками.

## Состав репозитория

- **cmd/EventBooker/main.go** — точка входа через FX DI.
- **internal/**
  - **app/booking** — бизнес-логика работы с бронированием.
  - **app/event** — бизнес-логика работы с ивентом.
  - **app/user** — бизнес-логика работы с юзером.
  - **auth** — инфраструктура jwt аутентификации.
  - **config/** — загрузка конфигурации из YAML.
  - **broker/rabbitmq** — консьюмер RabbitMQ (коннекшн, работа с паблишером и консьюмером).
  - **di/** — реализация зависимостей через UberFX.
  - **domain/booking** — модель бронирования
  - **domain/event** — модель ивента
  - **domain/user** — модель юзера
  - **db/** — работа с PostgreSQL (CRUD).
  - **sender/** — реализация отправки уведомлений (Telegram, Email).
  - **web/** — HTTP-обработчики и роутер.
- **config/local.yaml** — пример конфигурации.
- **migrations/** — SQL-миграции для PostgreSQL.
- **docs/** — Swagger-документация.
- **web/index.html** — простая страница регистрации, создания ивентов и бронирования мест на них.
- **docker-compose.yml** — запуск PostgreSQL, RAbbitMQ через Docker.
- **.env.example** - пример env файла для кредов.


---

## Быстрый старт

### 1. Запуск инфраструктуры

```sh
docker-compose up -d
```
(Запустит контейнеры: postgres → порт 5433, RabbitMQ → 5672/15672)

### 2. Настроить переменные окружения и конфигурацию
(пример в .env.example + config/local.yaml)

### 3. Применить миграции (migrate):

```sh
migrate -path migrations -database "postgres://user:password@localhost:5433/dbname?sslmode=disable" up
```

### 4. Запуск сервиса

```sh
go run ./cmd/EventBooker/main.go
```

Сервис стартует на порту 8080.

## API

- **POST /register** — регистрация пользователя (если реализуете многопользовательскую систему);
- **POST /login** — аутентификация пользователя (если реализуете многопользовательскую систему);
- **POST /events** — создание мероприятия;
- **POST /events/{id}/book** — бронирование места;
- **GET /events/{id}** — получение информации о мероприятии и свободных местах.
- **POST /events/{id}/confirm** —  оплата брони (если мероприятие требует этого);
- **Swagger**: [http://localhost:8080/swagger/index.html](http://localhost:8080/swagger/index.html)

---

Для защиты эндпоинтов используется JWT Bearer Auth:
- Все эндпоинты, связанные с созданием и бронированием мероприятий, требуют наличия JWT токена в заголовке Authorization: Bearer <token>.
- Токен генерируется при логине (POST /login) и может быть обновлен через POST /refresh.

Эндпоинты, не требующие авторизации:
- **POST /register** — регистрация пользователя
- **POST /login** — получение JWT

## Веб-интерфейс
Откройте index.html в браузере — простая страница регистрации, создания ивентов и бронирования мест на них.


## Тесты
Юнит-тесты: `go test ./internal/...`

## Миграции

- `migrations/000001_create_user_table.up.sql` — создание таблиц.
- `migrations/000001_create_user_table.down.sql` — удаление таблиц.
- `migrations/000002_create_event_table.up.sql` — создание таблиц.
- `migrations/000002_create_event_table.down.sql` — удаление таблиц.
- `migrations/000003_create_booking_table.up.sql` — создание таблиц.
- `migrations/000003_create_booking_table.down.sql` — удаление таблиц.

---

## Логирование и метрики
Логирование реализовано через wbf/zlog (используется в internal/*).

## Зависимости

- Go 1.25+
- PostgreSQL 16+
- RabbitMQ 3.13+
- Docker (для локального запуска инфраструктуры)

---

## Swagger

- Swagger: [docs/swagger.yaml](docs/swagger.yaml)
- Документация генерируется автоматически и доступна по `/swagger/*`.